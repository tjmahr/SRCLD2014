---
title: "Notebook"
output:
  html_document:
    fig_width: 7
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library("knitr")
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
opts_knit$set(root.dir = "../")
```

```{r Load}
library("plyr")
library("dplyr")
library("reshape2")
library("ggplot2")
library("gtools")
library("lmSupport")




load("data/merged.RData")
scores <- merged %>%
  select(Subject, Age, Female, EVT_GSV_T1, EVT_Raw_T1, PPVT_GSV_T1, Intercept, Linear, 
         Quadratic, WordsPerHour, CTCPerHour, Meaningful, Age, Income, Medu) %>% 
  unique() %>% filter(!is.na(EVT_GSV_T1), !is.na(WordsPerHour)) %>% 
  mutate(Accuracy = inv.logit(Intercept) * 100)

with_ses <- scores %>% filter(!is.na(Income), !is.na(Medu))
  
```


```{r Subject summary}
d <- list()
d$n <- n_distinct(with_ses$Subject)
d$boys <- nrow(filter(with_ses, Female == 0))
d$girls <- d$n - d$boys
d$age_min <- min(with_ses$Age)
d$age_max <- max(with_ses$Age)
```


```{r Sample descriptives}
pp_mean_sd <- function(xs) sprintf("%s (%s)", round(mean(xs), 2), round(sd(xs), 2))
pp_range <- function(xs) sprintf("%s-%s", round(min(xs), 2), round(max(xs), 2))

mean_sd_table <- with_ses %>% summarise_each(funs(pp_mean_sd), -Subject, -Female) 
mean_pp_range <- with_ses %>% summarise_each(funs(pp_range), -Subject, -Female) 
described <- rbind(mean_sd_table, mean_pp_range)

row.names(described) <- c("Mean (SD)", "Range")

descriptives <- described %>% 
  select(-PPVT_GSV_T1,
    `Age (months)` = Age, 
    `EVT Growth Scale Value` = EVT_GSV_T1,
    `Hourly Conversation Turns` = CTCPerHour,
    `Hourly Adult Words` = WordsPerHour,
    `Proportion of Meaningful Speech` = Meaningful,
    `Income (6-step scale)` = Income,
    `Maternal Ed. (6-step scale)` = Medu) %>% t %>% as.data.frame
```


**Mat. Ed. coding**

1. Less than high school
2. GED
3. High school diploma
4. Trade school, technical/associates degree, some college
5. College degree
6. Graduate degree

**Income coding**

1. Below $20,000
2. $20,000 - $40,000
3. $41,000 - $60,000
4. $61,000 - $100,000
5. $101,000 - $200,000
6. More than $200,000

### Participants

* `r d$n` preschoolers (`r d$boys` boys, `r d$girls` girls), `r d$age_min`--`r d$age_max` months in age

```{r, results='asis'}
knitr::kable(descriptives)
```



```{r}
with_ses <- with_ses %>% 
  mutate(MeduC = ifelse(Medu < 5, "Below", ifelse(Medu == 5, "College", "Above")),
         MeduD = ifelse(Medu < 5, -.5, .5)) %>% 
  mutate(MeduC = factor(MeduC, levels = c("Below", "College", "Above")),
         MeduC2 = factor(MeduC, levels = c("College", "Below", "Above")))

qplot(with_ses$Medu)
qplot(with_ses$MeduC)
qplot(factor(with_ses$MeduD))


```

# Significant group differences. Reference group: Less than college
```{r}

ggplot(data = with_ses, aes(MeduC, EVT_GSV_T1)) + geom_point(position = position_jitter(.2)) + 
  stat_summary(fun.data=mean_se, size = 1) + labs(title = "Means with SEs")
qplot(data = with_ses, x = MeduC, y = EVT_GSV_T1, geom="boxplot") 
qplot(data = with_ses, x = MeduC, y = Linear, geom="boxplot") 

count(with_ses$MeduC)
lm.caseAnalysis(m_p)
with_ses[20, ]

se <- function(x) sqrt(var(x)/length(x))


with_ses %>% group_by(MeduC) %>% select(EVT_GSV_T1, Intercept, Linear, Meaningful, WordsPerHour, CTCPerHour) %>% summarise_each(funs(mean)) %>% mutate_each(funs(round(., 2)), -MeduC) %>% as.data.frame(t(.))




qplot(x = Age, y = Linear, color = MeduC, data = with_ses) + geom_smooth(method = "lm")
summary(lm(EVT_GSV_T1 ~ Linear + MeduC + Age, with_ses))
summary(lm(EVT_GSV_T1 ~ MeduC2, with_ses))
summary(lm(Linear ~ MeduC, with_ses))
summary(lm(Meaningful ~ MeduC, with_ses))
summary(lm(Meaningful ~ MeduC2, with_ses))
summary(lm(WordsPerHour ~ MeduC, with_ses))
summary(lm(WordsPerHour ~ MeduC2, with_ses))
summary(lm(CTCPerHour ~ MeduC, with_ses))
summary(lm(CTCPerHour ~ MeduC2, with_ses))
summary(lm(Linear ~ MeduC2, with_ses))
summary(lm(Intercept ~ MeduC, with_ses))
```


Vocab as a function of processing, at different levels of maternal ed
```{r}
fix_slope <- function(slope) {
  # Change in accuracy (percentage) over 1 second
  ((inv.logit(slope) * 100) / 2452.128) * 1000
}
p <- qplot(data = with_ses, x = fix_slope(Linear), y = EVT_Raw_T1, color = MeduC) 
p + stat_smooth(method = "lm")
p <- qplot(data = with_ses, x = Linear, y = EVT_Raw_T1, color = MeduC) 
p + stat_smooth(method = "lm")

m_processing <- lm(EVT_GSV_T1 ~ Linear * MeduC, with_ses)
summary(m_processing)

m_processing <- lm(EVT_GSV_T1 ~ Linear + Accuracy*MeduC, with_ses)
summary(m_processing)

# AWC
p <- qplot(data = with_ses, x = WordsPerHour, y = EVT_GSV_T1, color = MeduC) 
p + stat_smooth(method = "lm")
m_home1 <- lm(EVT_GSV_T1 ~ WordsPerHour*MeduC, with_ses)
summary(m_home1)


# CTC
p <- qplot(data = with_ses, x = CTCPerHour, y = EVT_GSV_T1, color = MeduC) 
p + stat_smooth(method = "lm")
m_home2 <- lm(EVT_GSV_T1 ~ CTCPerHour*MeduC, with_ses)
summary(m_home2)
m_home2 <- lm(EVT_GSV_T1 ~ CTCPerHour*MeduD, with_ses)
summary(m_home2)

# Meaningful
p <- qplot(data = with_ses, x = Meaningful, y = EVT_GSV_T1, color = MeduC) 
p + stat_smooth(method = "lm")
m_home3 <- lm(EVT_GSV_T1 ~ Meaningful*MeduC, with_ses)
summary(m_home3)
m_home3 <- lm(EVT_GSV_T1 ~ Meaningful*MeduD, with_ses)
summary(m_home3)

# CTC
p <- qplot(data = with_ses, x = CTCPerHour, y = Accuracy, color = MeduC) 
p + stat_smooth(method = "lm")
m_home2 <- lm(Accuracy ~ CTCPerHour*MeduC, with_ses)
summary(m_home2)

m_home2 <- lm(Accuracy ~ CTCPerHour*MeduD, with_ses)
summary(m_home2)

p <- qplot(data = with_ses, x = WordsPerHour, y = Accuracy, color = MeduC) 
p + stat_smooth(method = "lm")

p <- qplot(data = with_ses, x = Meaningful, y = Accuracy, color = MeduC) 
p + stat_smooth(method = "lm")



```

Now with dichotomized maternal ed
```{r}
p <- qplot(data = with_ses, x = Linear, y = EVT_GSV_T1, color = factor(MeduD))
p + stat_smooth(method = "lm")
m_processing <- lm(EVT_GSV_T1 ~ Linear * MeduD, with_ses)
summary(m_processing)

```



```{r, eval=FALSE}
# fix_slope <- function(slope) {
#   inv.logit(slope) / 2452.128
# }
# qplot(data = lj, x = Time - 1000, y = inv.logit(elogit)) + 
#   geom_abline(aes(slope = fix_slope(Linear), intercept = inv.logit(Intercept))) + facet_wrap("Subject")

```

